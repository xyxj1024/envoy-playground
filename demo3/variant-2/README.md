## Demo Setup

The demo code is mostly copied from [Solo.io Hoot Episode 4](https://github.com/solo-io/hoot/blob/master/04-xds/).

The Envoy instance will be dynamically configured by the control plane such that it [routes the traffic to two different clusters](https://github.com/envoyproxy/envoy/issues/18837) based on a weight value specified by the user. [The `weighted_clusters` configuration block](https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/traffic_splitting#traffic-splitting-across-multiple-upstreams) is set in LDS.

### Development Environment

```bash
$ set | grep "MACHTYPE"
MACHTYPE=x86_64-apple-darwin21

$ go version
go version go1.20.5 darwin/amd64

$ envoy --version | grep -o '[0-9].[0-9]\+.[0-9]' | tail -n1
1.26.2
```

### Run Code

```bash
# Open terminal one
go run app/app.go

# Open terminal two
envoy -c config/bootstrap.yaml -l debug

# Open terminal three
cd src
go mod init soloio-hoot-xds && go mod tidy
go build
go run soloio-hoot-xds
```

### Observe Envoy's Debugging Information

Without the control plane running, we can see the following debugging information generated by the running Envoy instance:

```bash
[./source/common/config/grpc_stream.h:52] Establishing new gRPC bidi stream to xds_cluster for rpc StreamAggregatedResources(stream .envoy.service.discovery.v3.DiscoveryRequest) returns (stream .envoy.service.discovery.v3.DiscoveryResponse);

[source/common/router/router.cc:478] [C0][S9402334318700897523] cluster 'xds_cluster' match for URL '/envoy.service.discovery.v3.AggregatedDiscoveryService/StreamAggregatedResources'
[source/common/router/router.cc:686] [C0][S9402334318700897523] router decoding headers:
':method', 'POST'
':path', '/envoy.service.discovery.v3.AggregatedDiscoveryService/StreamAggregatedResources'
':authority', 'xds_cluster'
':scheme', 'http'
'te', 'trailers'
'content-type', 'application/grpc'
'x-envoy-internal', 'true'
'x-forwarded-for', '192.168.1.248'

[source/common/http/conn_pool_base.cc:78] queueing stream due to no available connections (ready=0 busy=0 connecting=0)
[source/common/conn_pool/conn_pool_base.cc:291] trying to create new connection
[source/common/conn_pool/conn_pool_base.cc:145] creating a new connection (connecting=0)
[source/common/http/http2/codec_impl.cc:1586] [C6] updating connection-level initial window size to 268435456
[./source/common/network/connection_impl.h:98] [C6] current connecting state: true
[source/common/http/codec_client.cc:57] [C6] connecting
[source/common/network/connection_impl.cc:941] [C6] connecting to 127.0.0.1:9977
[source/common/network/connection_impl.cc:960] [C6] connection in progress
[source/common/network/connection_impl.cc:699] [C6] delayed connect error: 61
[source/common/network/connection_impl.cc:250] [C6] closing socket: 0
[source/common/http/codec_client.cc:107] [C6] disconnect. resetting 0 pending requests
[source/common/conn_pool/conn_pool_base.cc:484] [C6] client disconnected, failure reason: delayed connect error: 61
[source/common/router/router.cc:1278] [C0][S9402334318700897523] upstream reset: reset reason: connection failure, transport failure reason: delayed connect error: 61
[source/common/http/async_client_impl.cc:123] async http request response headers (end_stream=true):
':status', '200'
'content-type', 'application/grpc'
'grpc-status', '14'
'grpc-message', 'upstream connect error or disconnect/reset before headers. reset reason: connection failure, transport failure reason: delayed connect error: 61'

[./source/common/config/grpc_stream.h:197] StreamAggregatedResources gRPC config stream to xds_cluster closed: 14, upstream connect error or disconnect/reset before headers. reset reason: connection failure, transport failure reason: delayed connect error: 61
[source/common/config/grpc_subscription_impl.cc:115] gRPC update for type.googleapis.com/envoy.config.listener.v3.Listener failed
[source/common/config/grpc_subscription_impl.cc:115] gRPC update for type.googleapis.com/envoy.config.cluster.v3.Cluster failed
[source/common/conn_pool/conn_pool_base.cc:454] invoking idle callbacks - is_draining_for_deletion_=false
[source/server/server.cc:265] flushing stats
[source/server/server.cc:275] Envoy is not fully initialized, skipping histogram merge and flushing stats
[source/common/config/grpc_subscription_impl.cc:120] gRPC config: initial fetch timed out for type.googleapis.com/envoy.config.listener.v3.Listener
[source/common/init/watcher_impl.cc:14] target LDS initialized, notifying init manager Server
[source/common/init/watcher_impl.cc:14] init manager Server initialized, notifying RunHelper
[source/extensions/listener_managers/listener_manager/listener_manager_impl.cc:858] all dependencies initialized. starting workers
[source/extensions/listener_managers/listener_manager/listener_manager_impl.cc:895] starting worker 0
source/extensions/listener_managers/listener_manager/listener_manager_impl.cc:895] starting worker 1
[source/extensions/listener_managers/listener_manager/listener_manager_impl.cc:895] starting worker 2
[source/server/worker_impl.cc:140] worker entering dispatch loop
[source/server/worker_impl.cc:140] worker entering dispatch loop
[source/extensions/listener_managers/listener_manager/listener_manager_impl.cc:895] starting worker 3
[source/server/worker_impl.cc:140] worker entering dispatch loop
[source/common/upstream/cluster_manager_impl.cc:1126] adding TLS cluster xds_cluster
[source/common/upstream/cluster_manager_impl.cc:1126] adding TLS cluster xds_cluster
[source/common/upstream/cluster_manager_impl.cc:1211] membership update for TLS cluster xds_cluster added 1 removed 0
[source/common/grpc/google_async_client_impl.cc:51] completionThread running
[source/common/upstream/cluster_manager_impl.cc:1211] membership update for TLS cluster xds_cluster added 1 removed 0
[source/common/grpc/google_async_client_impl.cc:51] completionThread running
[source/common/grpc/google_async_client_impl.cc:51] completionThread running
[source/server/worker_impl.cc:140] worker entering dispatch loop
[source/common/upstream/cluster_manager_impl.cc:1126] adding TLS cluster xds_cluster
[source/common/upstream/cluster_manager_impl.cc:1126] adding TLS cluster xds_cluster
[source/common/upstream/cluster_manager_impl.cc:1211] membership update for TLS cluster xds_cluster added 1 removed 0
[source/common/grpc/google_async_client_impl.cc:51] completionThread running
[source/common/upstream/cluster_manager_impl.cc:1211] membership update for TLS cluster xds_cluster added 1 removed 0
```

Then, after starting the control plane, we can see the following:

```bash
[./source/common/config/grpc_stream.h:52] Establishing new gRPC bidi stream to xds_cluster for rpc StreamAggregatedResources(stream .envoy.service.discovery.v3.DiscoveryRequest) returns (stream .envoy.service.discovery.v3.DiscoveryResponse);

[source/common/router/router.cc:478] [C0][S60704993526752925] cluster 'xds_cluster' match for URL '/envoy.service.discovery.v3.AggregatedDiscoveryService/StreamAggregatedResources'
[source/common/router/router.cc:686] [C0][S60704993526752925] router decoding headers:
':method', 'POST'
':path', '/envoy.service.discovery.v3.AggregatedDiscoveryService/StreamAggregatedResources'
':authority', 'xds_cluster'
':scheme', 'http'
'te', 'trailers'
'content-type', 'application/grpc'
'x-envoy-internal', 'true'
'x-forwarded-for', '192.168.1.248'

[source/common/http/conn_pool_base.cc:78] queueing stream due to no available connections (ready=0 busy=0 connecting=0)
[source/common/conn_pool/conn_pool_base.cc:291] trying to create new connection
[source/common/conn_pool/conn_pool_base.cc:145] creating a new connection (connecting=0)
[source/common/http/http2/codec_impl.cc:1586] [C32] updating connection-level initial window size to 268435456
[./source/common/network/connection_impl.h:98] [C32] current connecting state: true
[2023-07-06 15:01:34.462][1112490][debug][client] [source/common/http/codec_client.cc:57] [C32] connecting
[source/common/network/connection_impl.cc:941] [C32] connecting to 127.0.0.1:9977
[source/common/network/connection_impl.cc:960] [C32] connection in progress
[source/common/network/connection_impl.cc:688] [C32] connected
[source/common/http/codec_client.cc:88] [C32] connected
[source/common/conn_pool/conn_pool_base.cc:328] [C32] attaching to next stream
[source/common/conn_pool/conn_pool_base.cc:182] [C32] creating stream
[source/common/router/upstream_request.cc:650] [C0][S60704993526752925] pool ready
[source/common/router/router.cc:1442] [C0][S60704993526752925] upstream headers complete: end_stream=false
[source/common/http/async_client_impl.cc:123] async http request response headers (end_stream=false):
':status', '200'
'content-type', 'application/grpc'

[source/common/config/grpc_mux_impl.cc:246] Received gRPC message for type.googleapis.com/envoy.config.cluster.v3.Cluster at version snapshot-1
[source/common/config/grpc_mux_impl.cc:223] Pausing discovery requests for type.googleapis.com/envoy.config.cluster.v3.Cluster (previous count 0)
[source/common/config/grpc_mux_impl.cc:223] Pausing discovery requests for type.googleapis.com/envoy.config.endpoint.v3.ClusterLoadAssignment (previous count 0)
[source/common/config/grpc_mux_impl.cc:223] Pausing discovery requests for type.googleapis.com/envoy.config.endpoint.v3.LbEndpoint (previous count 0)
[source/common/config/grpc_mux_impl.cc:223] Pausing discovery requests for type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.Secret (previous count 0)
[source/common/upstream/cds_api_helper.cc:32] cds: add 2 cluster(s), remove 1 cluster(s)
[source/common/network/dns_resolver/dns_factory_util.cc:42] create Apple DNS resolver type: envoy.network.dns_resolver.apple in MacOS.
[source/common/network/dns_resolver/dns_factory_util.cc:81] create DNS resolver type: envoy.network.dns_resolver.apple
[./source/common/http/filter_chain_helper.h:88]     upstream http filter #0
[./source/common/http/filter_chain_helper.h:118]       name: envoy.filters.http.upstream_codec
[./source/common/http/filter_chain_helper.h:121]     config: {"@type":"type.googleapis.com/envoy.extensions.filters.http.upstream_codec.v3.UpstreamCodec"}
[source/common/config/grpc_mux_impl.cc:223] Pausing discovery requests for type.googleapis.com/envoy.config.cluster.v3.Cluster (previous count 1)
[source/common/upstream/cluster_manager_impl.cc:779] add/update cluster cluster_a starting warming
[source/extensions/clusters/logical_dns/logical_dns_cluster.cc:106] starting async DNS resolution for 127.0.0.1
[source/extensions/network/dns_resolver/apple/apple_dns_impl.cc:63] DNS resolution for 127.0.0.1 started
[source/extensions/network/dns_resolver/apple/apple_dns_impl.cc:74] DNS resolver resolved (127.0.0.1) to (127.0.0.1:0) without issuing call to Apple API
[source/extensions/clusters/logical_dns/logical_dns_cluster.cc:114] async DNS resolution complete for 127.0.0.1
[source/common/upstream/upstream_impl.cc:457] transport socket match, socket default selected for host with address 127.0.0.1:8082
[source/extensions/clusters/logical_dns/logical_dns_cluster.cc:165] DNS refresh rate reset for 127.0.0.1, refresh rate 5000 ms
[source/common/upstream/upstream_impl.cc:1518] initializing Primary cluster cluster_a completed
[source/common/init/manager_impl.cc:49] init manager Cluster cluster_a contains no targets
[source/common/init/watcher_impl.cc:14] init manager Cluster cluster_a initialized, notifying ClusterImplBase
[source/common/upstream/cluster_manager_impl.cc:781] warming cluster cluster_a complete
[source/common/config/grpc_mux_impl.cc:230] Decreasing pause count on discovery requests for type.googleapis.com/envoy.config.cluster.v3.Cluster (previous count 2)
[source/common/upstream/cluster_manager_impl.cc:1126] adding TLS cluster cluster_a
[source/common/upstream/cluster_manager_impl.cc:1126] adding TLS cluster cluster_a
[source/common/upstream/cluster_manager_impl.cc:1211] membership update for TLS cluster cluster_a added 1 removed 0
[source/common/upstream/cluster_manager_impl.cc:1126] adding TLS cluster cluster_a
[source/common/upstream/cluster_manager_impl.cc:1126] adding TLS cluster cluster_a
[source/common/upstream/cluster_manager_impl.cc:1126] adding TLS cluster cluster_a
[source/common/upstream/cluster_manager_impl.cc:1211] membership update for TLS cluster cluster_a added 1 removed 0
[source/common/upstream/cluster_manager_impl.cc:1211] membership update for TLS cluster cluster_a added 1 removed 0
[source/common/upstream/cluster_manager_impl.cc:1211] membership update for TLS cluster cluster_a added 1 removed 0
[source/common/upstream/cluster_manager_impl.cc:1211] membership update for TLS cluster cluster_a added 1 removed 0
[source/common/upstream/cds_api_helper.cc:49] cds: add/update cluster 'cluster_a'

# ...
# Similar for cluster_b

[source/common/config/grpc_mux_impl.cc:246] Received gRPC message for type.googleapis.com/envoy.config.listener.v3.Listener at version snapshot-1
[source/common/config/grpc_mux_impl.cc:223] Pausing discovery requests for type.googleapis.com/envoy.config.listener.v3.Listener (previous count 0)
[source/common/config/grpc_mux_impl.cc:223] Pausing discovery requests for type.googleapis.com/envoy.config.route.v3.RouteConfiguration (previous count 0)
[source/common/config/grpc_mux_impl.cc:223] Pausing discovery requests for type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.Secret (previous count 0)
[source/extensions/listener_managers/listener_manager/listener_manager_impl.cc:474] begin add/update listener: name=listener_0 hash=14533081949922451890
[source/extensions/listener_managers/listener_manager/listener_manager_impl.cc:511] use full listener update path for listener name=listener_0 hash=14533081949922451890
[source/extensions/listener_managers/listener_manager/listener_impl.cc:1095] reuse_port was configured for TCP listener 'listener_0' and is being force disabled because Envoy is not running on Linux. See the documentation for more information.
[source/extensions/listener_managers/listener_manager/listener_manager_impl.cc:88]   filter #0:
[source/extensions/listener_managers/listener_manager/listener_manager_impl.cc:89]     name: envoy.filters.network.http_connection_manager
[source/extensions/listener_managers/listener_manager/listener_manager_impl.cc:92]   config: {"@type":"type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager","stat_prefix":"http","http_filters":[{"name":"envoy.filters.http.router","typed_config":{"@type":"type.googleapis.com/envoy.extensions.filters.http.router.v3.Router"}}],"rds":{"config_source":{"resource_api_version":"V3","api_config_source":{"api_type":"GRPC","grpc_services":[{"envoy_grpc":{"cluster_name":"xds_cluster"}}],"set_node_on_first_message_only":true,"transport_api_version":"V3"}},"route_config_name":"local_route"}}
[source/common/init/manager_impl.cc:24] added target RdsRouteConfigSubscription RDS local-init-target local_route to init manager RDS local-init-manager local_route
[source/common/init/manager_impl.cc:24] added shared target RdsRouteConfigSubscription RDS init local_route to init manager Listener-local-init-manager listener_0 14533081949922451890
[./source/common/http/filter_chain_helper.h:88]     http filter #0
[./source/common/http/filter_chain_helper.h:118]       name: envoy.filters.http.router
[./source/common/http/filter_chain_helper.h:121]     config: {"@type":"type.googleapis.com/envoy.extensions.filters.http.router.v3.Router"}
[source/extensions/listener_managers/listener_manager/filter_chain_manager_impl.cc:322] new fc_contexts has 1 filter chains, including 1 newly built
[source/extensions/listener_managers/listener_manager/listener_impl.cc:156] Create listen socket for listener listener_0 on address 0.0.0.0:10000
[source/extensions/listener_managers/listener_manager/listener_impl.cc:166] listener_0: Setting socket options succeeded
[source/extensions/listener_managers/listener_manager/listener_impl.cc:109] Set listener listener_0 socket factory local address to 0.0.0.0:10000
[source/extensions/listener_managers/listener_manager/listener_impl.cc:968] add warming listener: name=listener_0, hash=14533081949922451890, tag=1, address=0.0.0.0:10000
[source/extensions/listener_managers/listener_manager/listener_impl.cc:977] Initialize listener listener_0 local-init-manager.
[source/common/init/manager_impl.cc:53] init manager Listener-local-init-manager listener_0 14533081949922451890 initializing
[source/common/init/target_impl.cc:15] init manager Listener-local-init-manager listener_0 14533081949922451890 initializing shared target RdsRouteConfigSubscription RDS init local_route
[source/common/init/manager_impl.cc:53] init manager RDS local-init-manager local_route initializing
[source/common/init/target_impl.cc:15] init manager RDS local-init-manager local_route initializing target RdsRouteConfigSubscription RDS local-init-target local_route
[source/common/config/grpc_mux_impl.cc:193] gRPC mux addWatch for type.googleapis.com/envoy.config.route.v3.RouteConfiguration
```

We can issue a `curl` request to the Envoy instance:

```bash
# Open terminal four
curl -i http://localhost:10000/
```

And Envoy updates debugging information as follows:

```bash
[source/extensions/listener_managers/listener_manager/active_tcp_listener.cc:155] [C35] new connection from 127.0.0.1:61641
[source/common/http/conn_manager_impl.cc:349] [C35] new stream
[source/common/http/conn_manager_impl.cc:1039] [C35][S7850267705120786316] request headers complete (end_stream=true):
':authority', 'localhost:10000'
':path', '/'
':method', 'GET'
'user-agent', 'curl/8.2.0-DEV'
'accept', '*/*'

[source/common/http/conn_manager_impl.cc:1022] [C35][S7850267705120786316] request end stream
[./source/common/network/connection_impl.h:98] [C35] current connecting state: false
[source/common/router/router.cc:478] [C35][S7850267705120786316] cluster 'cluster_a' match for URL '/'
[source/common/router/router.cc:686] [C35][S7850267705120786316] router decoding headers:
':authority', '127.0.0.1'
':path', '/'
':method', 'GET'
':scheme', 'http'
'user-agent', 'curl/8.2.0-DEV'
'accept', '*/*'
'x-forwarded-proto', 'http'
'x-request-id', '497c74a7-6377-404b-8d54-71540e29cade'
'x-envoy-expected-rq-timeout-ms', '15000'

[source/common/conn_pool/conn_pool_base.cc:265] [C34] using existing fully connected connection
[source/common/conn_pool/conn_pool_base.cc:182] [C34] creating stream
[source/common/router/upstream_request.cc:650] [C35][S7850267705120786316] pool ready
[source/common/http/codec_client.cc:139] [C34] encode complete
[source/common/router/router.cc:1442] [C35][S7850267705120786316] upstream headers complete: end_stream=false
[source/common/http/conn_manager_impl.cc:1680] [C35][S7850267705120786316] encoding headers via codec (end_stream=false):
':status', '200'
'date', 'Thu, 06 Jul 2023 20:17:35 GMT'
'content-length', '6'
'content-type', 'text/plain; charset=utf-8'
'x-envoy-upstream-service-time', '0'
'server', 'envoy'

[source/common/http/codec_client.cc:126] [C34] response complete
[source/common/http/conn_manager_impl.cc:1772] [C35][S7850267705120786316] Codec completed encoding stream.
[source/common/http/http1/conn_pool.cc:53] [C34] response complete
[source/common/conn_pool/conn_pool_base.cc:215] [C34] destroying stream: 0 remaining
[source/common/network/connection_impl.cc:656] [C35] remote close
[source/common/network/connection_impl.cc:250] [C35] closing socket: 0
[source/extensions/listener_managers/listener_manager/active_stream_listener_base.cc:121] [C35] adding to cleanup list
```

Generate traffic and see statistics:

```bash
while true; do hey -n 100 -c 5 -t 1  http://localhost:10000/ ; sleep 1; done
```

Black Server returns response code 200 and White Server returns response code 201.